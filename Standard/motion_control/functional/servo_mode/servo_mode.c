/*2023-10-04T11:03:55-01:00*/

/********************************************************************
 * servo_mode.c
 * 
 * generated by: plcgen 3.1.391
 ********************************************************************/

#include "cb_comp.h"
#include "iec_1131.h"

#include "servo_mode.h"



/**************************** Variables *****************************/

CB_Index servo_mode__num = 0;
CB_Mem_Bool *servo_mode_PLC_StatusReady;
CB_Mem_Bool *servo_mode_PLC_StatusMoved;
CB_Mem_Bool *servo_mode_PLC_StatusStand;
CB_Mem_Float *servo_mode_PLC_ActualPositionAx;
CB_Mem_Float *servo_mode_PLC_ActualPositionMa;
CB_Mem_Float *servo_mode_PLC_ActualVelocity;
CB_Mem_Bool *servo_mode_StatusReady;
CB_Mem_Bool *servo_mode_StatusMoved;
CB_Mem_Bool *servo_mode_StatusStand;
CB_Mem_Float *servo_mode_ActualPositionMa;
CB_Mem_Float *servo_mode_ActualVelocity;
CB_Mem_Float *servo_mode_MaximumVelocity;
CB_Mem_Float *servo_mode_physicalPosInit;
CB_Mem_Float *servo_mode_ActualPositionAx;
CB_Mem_Bool *servo_mode_StatusReady_o;
CB_Mem_Bool *servo_mode_StatusMoved_o;
CB_Mem_Bool *servo_mode_StatusStand_o;
CB_Mem_Float *servo_mode_ActualPositionAx_o;
CB_Mem_Float *servo_mode_ActualPositionMa_o;
CB_Mem_Float *servo_mode_ActualVelocity_o;
CB_Mem_Float *servo_mode_MaximumVelocity_o;
CB_Mem_Bool *servo_mode_StatusPosIncrease_o;
CB_Mem_Bool *servo_mode_StatusPosDecrease_o;
CB_Mem_Float *servo_mode_displayJauge_o;
CB_Mem_Bool *servo_mode_PLCMode;
CB_Mem_Bool *servo_mode_PLCMode1;
CB_Mem_Bool *servo_mode_initDone;
CB_Mem_Float *servo_mode_displayPosMin;
CB_Mem_Float *servo_mode_displayPosMax;
CB_Mem_Float *servo_mode_PLC_ActualPositionAx1;
CB_Mem_Float *servo_mode_PLC_ActualVelocity1;
CB_Mem_Float *servo_mode_ActualPositionAx1;
CB_Mem_Float *servo_mode_ActualVelocity1;
CB_Mem_Float *servo_mode_offsetAxToMa;
CB_Mem_Float *servo_mode_offsetAxToMa1;
CB_Mem_Float *servo_mode_ActualPositionMa_o1;

/**************************** Variables *****************************/

#define PLC_StatusReady (servo_mode_PLC_StatusReady->CB_current_value)
#define PLC_StatusMoved (servo_mode_PLC_StatusMoved->CB_current_value)
#define PLC_StatusStand (servo_mode_PLC_StatusStand->CB_current_value)
#define PLC_ActualPositionAx (servo_mode_PLC_ActualPositionAx->CB_current_value)
#define PLC_ActualPositionMa (servo_mode_PLC_ActualPositionMa->CB_current_value)
#define PLC_ActualVelocity (servo_mode_PLC_ActualVelocity->CB_current_value)
#define StatusReady (servo_mode_StatusReady->CB_current_value)
#define StatusMoved (servo_mode_StatusMoved->CB_current_value)
#define StatusStand (servo_mode_StatusStand->CB_current_value)
#define ActualPositionMa (servo_mode_ActualPositionMa->CB_current_value)
#define ActualVelocity (servo_mode_ActualVelocity->CB_current_value)
#define MaximumVelocity (servo_mode_MaximumVelocity->CB_current_value)
#define physicalPosInit (servo_mode_physicalPosInit->CB_current_value)
#define ActualPositionAx (servo_mode_ActualPositionAx->CB_current_value)
#define StatusReady_o (servo_mode_StatusReady_o->CB_current_value)
#define StatusMoved_o (servo_mode_StatusMoved_o->CB_current_value)
#define StatusStand_o (servo_mode_StatusStand_o->CB_current_value)
#define ActualPositionAx_o (servo_mode_ActualPositionAx_o->CB_current_value)
#define ActualPositionMa_o (servo_mode_ActualPositionMa_o->CB_current_value)
#define ActualVelocity_o (servo_mode_ActualVelocity_o->CB_current_value)
#define MaximumVelocity_o (servo_mode_MaximumVelocity_o->CB_current_value)
#define StatusPosIncrease_o (servo_mode_StatusPosIncrease_o->CB_current_value)
#define StatusPosDecrease_o (servo_mode_StatusPosDecrease_o->CB_current_value)
#define displayJauge_o (servo_mode_displayJauge_o->CB_current_value)
#define PLCMode (servo_mode_PLCMode->CB_current_value)
#define PLCMode1 (servo_mode_PLCMode1->CB_current_value)
#define initDone (servo_mode_initDone->CB_current_value)
#define displayPosMin (servo_mode_displayPosMin->CB_current_value)
#define displayPosMax (servo_mode_displayPosMax->CB_current_value)
#define PLC_ActualPositionAx1 (servo_mode_PLC_ActualPositionAx1->CB_current_value)
#define PLC_ActualVelocity1 (servo_mode_PLC_ActualVelocity1->CB_current_value)
#define ActualPositionAx1 (servo_mode_ActualPositionAx1->CB_current_value)
#define ActualVelocity1 (servo_mode_ActualVelocity1->CB_current_value)
#define offsetAxToMa (servo_mode_offsetAxToMa->CB_current_value)
#define offsetAxToMa1 (servo_mode_offsetAxToMa1->CB_current_value)
#define ActualPositionMa_o1 (servo_mode_ActualPositionMa_o1->CB_current_value)


/************************ Components offsets ************************/


/********************* Initialization function **********************/

int _motion_control__servo_mode_init(void)
{
	(servo_mode_PLC_StatusReady)->CB_current_value = 1; /*PLC_StatusReady*/
	(servo_mode_StatusReady)->CB_current_value = 1; /*StatusReady*/
	(servo_mode_StatusReady_o)->CB_current_value = 1; /*StatusReady_o*/
	self.Bool+=3;
	self.Float+=9;


	return 0;
}


/************************ Behavior function *************************/

int motion_control__servo_mode(void)
{
	if (exec_term_node(self_num)) {

		/*********************** Internals variables ************************/

		servo_mode_PLCMode = self.Bool+0;
		servo_mode_PLCMode1 = self.Bool+1;
		servo_mode_initDone = self.Bool+2;
		servo_mode_displayPosMin = self.Float+0;
		servo_mode_displayPosMax = self.Float+1;
		servo_mode_PLC_ActualPositionAx1 = self.Float+2;
		servo_mode_PLC_ActualVelocity1 = self.Float+3;
		servo_mode_ActualPositionAx1 = self.Float+4;
		servo_mode_ActualVelocity1 = self.Float+5;
		servo_mode_offsetAxToMa = self.Float+6;
		servo_mode_offsetAxToMa1 = self.Float+7;
		servo_mode_ActualPositionMa_o1 = self.Float+8;

		/********************* Pre-conditions execution *********************/

		/*no Pre-conditions*/

		/************************ Behavior execution ************************/

		{

			if (!initDone) {
				PLC_ActualPositionAx = physicalPosInit;
				PLC_ActualPositionMa = physicalPosInit;
				ActualPositionAx = physicalPosInit;
				ActualPositionMa = physicalPosInit;
			} else {
				if (PLC_ActualPositionAx1 != PLC_ActualPositionAx) PLCMode = 1;
				if (PLC_ActualVelocity1 != PLC_ActualVelocity) PLCMode = 1;
				if (ActualPositionAx1 != ActualPositionAx) PLCMode = 0;
				if (ActualVelocity1 != ActualVelocity) PLCMode = 0;
				if (PLCMode != PLCMode1) {
					if (PLCMode == 0) ActualPositionAx = PLC_ActualPositionAx;
				}
				PLCMode1 = PLCMode;
			}

			// modification of ref position
			if (offsetAxToMa != offsetAxToMa1) {
				displayPosMax += (offsetAxToMa - offsetAxToMa1);
				displayPosMin += (offsetAxToMa - offsetAxToMa1);
			}

			if (PLCMode) {
				StatusReady_o = PLC_StatusReady;
				StatusMoved_o = (PLC_StatusStand == 0);
				StatusStand_o = PLC_StatusStand;
				ActualPositionAx_o = PLC_ActualPositionAx;
				ActualPositionMa_o = PLC_ActualPositionMa;
				ActualVelocity_o = PLC_ActualVelocity;
				MaximumVelocity_o = MaximumVelocity;
			} else {
				StatusReady_o = StatusReady;
				StatusMoved_o = StatusMoved;
				StatusStand_o = StatusStand;
				ActualPositionAx_o = ActualPositionAx;
				ActualPositionMa_o = ActualPositionMa;
				ActualVelocity_o = ActualVelocity;
				MaximumVelocity_o = MaximumVelocity;
			}


			// DISPLAY CALC
			if (initDone == 0) {
				displayPosMax = ActualPositionMa_o;
				displayPosMin = ActualPositionMa_o;
			}
			if (ActualPositionMa_o1 != ActualPositionMa_o) {
				if (ActualPositionMa_o > displayPosMax) {
					displayPosMax = ActualPositionMa_o;
					displayJauge_o = 100*(ActualPositionMa_o - displayPosMin)/(displayPosMax - displayPosMin);
				} else {
					if (ActualPositionMa_o < displayPosMin) {
						displayPosMin = ActualPositionMa_o;
						displayJauge_o = 100 - 100*(displayPosMax - ActualPositionMa_o )/(displayPosMax - displayPosMin);
					} else {
						if (displayPosMax != displayPosMin) displayJauge_o = 100*(ActualPositionMa_o - displayPosMin)/(displayPosMax - displayPosMin);
					}
				}
			}


			if (ActualVelocity_o > 0.0) StatusPosIncrease_o = 1; else StatusPosIncrease_o = 0;
			if (ActualVelocity_o < 0.0) StatusPosDecrease_o = 1; else StatusPosDecrease_o = 0;

			offsetAxToMa1 = offsetAxToMa;

			PLC_ActualPositionAx1 = PLC_ActualPositionAx;
			PLC_ActualVelocity1 = PLC_ActualVelocity;
			ActualPositionAx1 = ActualPositionAx;
			ActualVelocity1 = ActualVelocity;

			initDone = 1;




		}

		CB_post_bool(servo_mode_StatusReady_o);
		CB_post_bool(servo_mode_StatusMoved_o);
		CB_post_bool(servo_mode_StatusStand_o);
		CB_post_float(servo_mode_ActualPositionAx_o);
		CB_post_float(servo_mode_ActualPositionMa_o);
		CB_post_float(servo_mode_ActualVelocity_o);
		CB_post_float(servo_mode_MaximumVelocity_o);
		CB_post_bool(servo_mode_StatusPosIncrease_o);
		CB_post_bool(servo_mode_StatusPosDecrease_o);
		CB_post_float(servo_mode_displayJauge_o);

		/******************** Post-conditions execution *********************/

		/*no Post-conditions*/
	}

	/*************************** self update ****************************/

	self.Bool += 3;
	self.Float += 9;

	return 0;
}

