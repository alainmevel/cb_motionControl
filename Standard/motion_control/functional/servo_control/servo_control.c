/*2023-10-04T11:03:55-01:00*/

/********************************************************************
 * servo_control.c
 * 
 * generated by: plcgen 3.1.391
 ********************************************************************/

#include "cb_comp.h"
#include "iec_1131.h"

#include "servo_control.h"



/**************************** Variables *****************************/

CB_Index servo_control__num = 0;
CB_Mem_Bool *servo_control_HomeCmd;
CB_Mem_Bool *servo_control_MoveVelCmd;
CB_Mem_Bool *servo_control_MoveAbsCmd;
CB_Mem_Bool *servo_control_MoveVel1ManualCmd;
CB_Mem_Bool *servo_control_MoveVel2ManualCmd;
CB_Mem_Bool *servo_control_MoveAbs1ManualCmd;
CB_Mem_Bool *servo_control_MoveAbs2ManualCmd;
CB_Mem_Bool *servo_control_StopCmd;
CB_Mem_Float *servo_control_MovePosition;
CB_Mem_Float *servo_control_MoveSpeed;
CB_Mem_Float *servo_control_MoveAcceleration;
CB_Mem_Float *servo_control_MoveDeceleration;
CB_Mem_Float *servo_control_offsetAxToMa;
CB_Mem_Float *servo_control_physicalPosInit;
CB_Mem_Float *servo_control_MAX_SPEED;
CB_Mem_Int *servo_control_status;
CB_Mem_Int *servo_control_errorFlag;
CB_Mem_Float *servo_control_IOActualPositionAx;
CB_Mem_Bool *servo_control_IOVelDone;
CB_Mem_Bool *servo_control_IOAbsDone;
CB_Mem_Float *servo_control_IOActualVelocity;
CB_Mem_Int *servo_control_OperationMode;
CB_Mem_Bool *servo_control_StatusReady;
CB_Mem_Bool *servo_control_StatusMove;
CB_Mem_Bool *servo_control_StatusStand;
CB_Mem_Float *servo_control_ActualPositionMa;
CB_Mem_Float *servo_control_ActualVelocity;
CB_Mem_Float *servo_control_MaximumVelocity;
CB_Mem_Bool *servo_control_VelEnabled;
CB_Mem_Bool *servo_control_VelCmd;
CB_Mem_Bool *servo_control_PosEnabled;
CB_Mem_Bool *servo_control_PosCmd;
CB_Mem_Float *servo_control_Position;
CB_Mem_Float *servo_control_Speed;
CB_Mem_Int *servo_control_ManualMode;
CB_Mem_Bool *servo_control_initDone;
CB_Mem_Float *servo_control_ActualPositionMa1;
CB_Mem_Float *servo_control_offsetAxToMa1;
CB_Mem_Float *servo_control_HOME_POSITION;
CB_Mem_Float *servo_control_MANUAL_POSITION1;
CB_Mem_Float *servo_control_MANUAL_POSITION2;
CB_Mem_Float *servo_control_MANUAL_SPEED1;
CB_Mem_Float *servo_control_MANUAL_SPEED2;
CB_Mem_Float *servo_control_MANUAL_SPEED;

/**************************** Variables *****************************/

#define HomeCmd (servo_control_HomeCmd->CB_current_value)
#define MoveVelCmd (servo_control_MoveVelCmd->CB_current_value)
#define MoveAbsCmd (servo_control_MoveAbsCmd->CB_current_value)
#define MoveVel1ManualCmd (servo_control_MoveVel1ManualCmd->CB_current_value)
#define MoveVel2ManualCmd (servo_control_MoveVel2ManualCmd->CB_current_value)
#define MoveAbs1ManualCmd (servo_control_MoveAbs1ManualCmd->CB_current_value)
#define MoveAbs2ManualCmd (servo_control_MoveAbs2ManualCmd->CB_current_value)
#define StopCmd (servo_control_StopCmd->CB_current_value)
#define MovePosition (servo_control_MovePosition->CB_current_value)
#define MoveSpeed (servo_control_MoveSpeed->CB_current_value)
#define MoveAcceleration (servo_control_MoveAcceleration->CB_current_value)
#define MoveDeceleration (servo_control_MoveDeceleration->CB_current_value)
#define offsetAxToMa (servo_control_offsetAxToMa->CB_current_value)
#define physicalPosInit (servo_control_physicalPosInit->CB_current_value)
#define MAX_SPEED (servo_control_MAX_SPEED->CB_current_value)
#define status (*((short *)&(servo_control_status->CB_current_value) + ALIGN_OFFSET_SHORT))
#define errorFlag (*((short *)&(servo_control_errorFlag->CB_current_value) + ALIGN_OFFSET_SHORT))
#define IOActualPositionAx (servo_control_IOActualPositionAx->CB_current_value)
#define IOVelDone (servo_control_IOVelDone->CB_current_value)
#define IOAbsDone (servo_control_IOAbsDone->CB_current_value)
#define IOActualVelocity (servo_control_IOActualVelocity->CB_current_value)
#define OperationMode (*((short *)&(servo_control_OperationMode->CB_current_value) + ALIGN_OFFSET_SHORT))
#define StatusReady (servo_control_StatusReady->CB_current_value)
#define StatusMove (servo_control_StatusMove->CB_current_value)
#define StatusStand (servo_control_StatusStand->CB_current_value)
#define ActualPositionMa (servo_control_ActualPositionMa->CB_current_value)
#define ActualVelocity (servo_control_ActualVelocity->CB_current_value)
#define MaximumVelocity (servo_control_MaximumVelocity->CB_current_value)
#define VelEnabled (servo_control_VelEnabled->CB_current_value)
#define VelCmd (servo_control_VelCmd->CB_current_value)
#define PosEnabled (servo_control_PosEnabled->CB_current_value)
#define PosCmd (servo_control_PosCmd->CB_current_value)
#define Position (servo_control_Position->CB_current_value)
#define Speed (servo_control_Speed->CB_current_value)
#define ManualMode (*((short *)&(servo_control_ManualMode->CB_current_value) + ALIGN_OFFSET_SHORT))
#define initDone (servo_control_initDone->CB_current_value)
#define ActualPositionMa1 (servo_control_ActualPositionMa1->CB_current_value)
#define offsetAxToMa1 (servo_control_offsetAxToMa1->CB_current_value)
#define HOME_POSITION (servo_control_HOME_POSITION->CB_current_value)
#define MANUAL_POSITION1 (servo_control_MANUAL_POSITION1->CB_current_value)
#define MANUAL_POSITION2 (servo_control_MANUAL_POSITION2->CB_current_value)
#define MANUAL_SPEED1 (servo_control_MANUAL_SPEED1->CB_current_value)
#define MANUAL_SPEED2 (servo_control_MANUAL_SPEED2->CB_current_value)
#define MANUAL_SPEED (servo_control_MANUAL_SPEED->CB_current_value)


/************************ Components offsets ************************/


/********************* Initialization function **********************/

int _motion_control__servo_control_init(void)
{
	(servo_control_MoveSpeed)->CB_current_value = 100.0; /*MoveSpeed*/
	(servo_control_MoveAcceleration)->CB_current_value = 100.0; /*MoveAcceleration*/
	(servo_control_MoveDeceleration)->CB_current_value = 100.0; /*MoveDeceleration*/
	(servo_control_MAX_SPEED)->CB_current_value = 1000.0; /*MAX_SPEED*/
	(servo_control_StatusReady)->CB_current_value = 1; /*StatusReady*/
	(self.Float+2)->CB_current_value = 100.0; /*HOME_POSITION*/
	(self.Float+4)->CB_current_value = 150.0; /*MANUAL_POSITION2*/
	(self.Float+5)->CB_current_value = (-100.0); /*MANUAL_SPEED1*/
	(self.Float+6)->CB_current_value = 100.0; /*MANUAL_SPEED2*/
	(self.Float+7)->CB_current_value = 100.0; /*MANUAL_SPEED*/
	self.Bool+=1;
	self.Int+=1;
	self.Float+=8;


	return 0;
}


/************************ Behavior function *************************/

int motion_control__servo_control(void)
{
	if (exec_term_node(self_num)) {

		/*********************** Internals variables ************************/

		servo_control_ManualMode = self.Int+0;
		servo_control_initDone = self.Bool+0;
		servo_control_ActualPositionMa1 = self.Float+0;
		servo_control_offsetAxToMa1 = self.Float+1;
		servo_control_HOME_POSITION = self.Float+2;
		servo_control_MANUAL_POSITION1 = self.Float+3;
		servo_control_MANUAL_POSITION2 = self.Float+4;
		servo_control_MANUAL_SPEED1 = self.Float+5;
		servo_control_MANUAL_SPEED2 = self.Float+6;
		servo_control_MANUAL_SPEED = self.Float+7;

		/********************* Pre-conditions execution *********************/

		if (allowpreconditions->CB_current_value) {
			if (!((0.0 <= MAX_SPEED) && (MAX_SPEED <= 3.4e+38))) {
				raise_debug_break(servo_control_MAX_SPEED - mem.Float, INPRE, OUTOFRANGESFLOAT, 0);
				return servo_control__num; /*assertion failure*/
			}
		}

		/************************ Behavior execution ************************/

		{
			/* ----------------------------------------------------------------	*/
			/* Type : Model of Operative Behaviour					*/
			/* Category :  motion control						*/
			/* Author : 									*/
			/* Update date : June 2021							*/
			/* ----------------------------------------------------------------	*/
			/* This module control the accesses to control the motion drive 	*/
			/* ----------------------------------------------------------------	*/

			if (initDone == 0) {
				IOActualPositionAx = physicalPosInit;
			}
			// modification of ref position
			if (offsetAxToMa != offsetAxToMa1) {
				ActualPositionMa += (offsetAxToMa - offsetAxToMa1);
				ActualPositionMa1 += (offsetAxToMa - offsetAxToMa1);
			}
			if (MoveVel1ManualCmd && StatusReady) {
				ManualMode = 1;
				StatusReady = 0;
				Speed = MANUAL_SPEED1;
				PosEnabled = 0;
				VelEnabled = 1;
				PosCmd = 0;
				VelCmd = 1;
			}
			if (MoveVel2ManualCmd && StatusReady) {
				ManualMode = 1;
				StatusReady = 0;
				Speed = MANUAL_SPEED2;
				PosEnabled = 0;
				VelEnabled = 1;
				PosCmd = 0;
				VelCmd = 1;
			}
			if (MoveAbs1ManualCmd && StatusReady) {
				ManualMode = 3;
				StatusReady = 0;
				Position = MANUAL_POSITION1;
				Speed = MANUAL_SPEED;
				PosEnabled = 1;
				VelEnabled = 0;
				PosCmd = 1;
				VelCmd = 0;
			}
			if (MoveAbs2ManualCmd && StatusReady) {
				ManualMode = 3;
				StatusReady = 0;
				Position = MANUAL_POSITION2;
				Speed = MANUAL_SPEED;
				PosEnabled = 1;
				VelEnabled = 0;
				PosCmd = 1;
				VelCmd = 0;
			}
			if (HomeCmd && StatusReady) {
				OperationMode = 1;
				StatusReady = 0;
				Position = HOME_POSITION;
				Speed = MoveSpeed;
				PosEnabled = 1;
				VelEnabled = 0;
				PosCmd = 1;
				VelCmd = 0;
			}
			if (MoveVelCmd && StatusReady) {
				OperationMode = 2;
				StatusReady = 0;
				Speed = MoveSpeed;
				PosEnabled = 0;
				VelEnabled = 1;
				PosCmd = 0;
				VelCmd = 1;
			}
			if (MoveAbsCmd && StatusReady) {
				OperationMode = 3;
				StatusReady = 0;
				Position = MovePosition - offsetAxToMa;
				Speed = MoveSpeed;
				PosEnabled = 1;
				VelEnabled = 0;
				PosCmd = 1;
				VelCmd = 0;
			}
			if ((OperationMode != 0 && StopCmd) || (OperationMode == 2 && !MoveVelCmd) || status == 5) {
				OperationMode = 0;
				ManualMode = 0;
				PosCmd = 0;
				VelCmd = 0;
			}
			if (ManualMode == 1 && !MoveVel1ManualCmd && !MoveVel2ManualCmd) {
				OperationMode = 0;
				ManualMode = 0;
				PosCmd = 0;
				VelCmd = 0;
			}
			if (OperationMode == 0 && ManualMode == 0 && status == 0) {
				StatusReady = 1;
				PosEnabled = 0;
				VelEnabled = 0;
			}

			ActualVelocity = IOActualVelocity;
			StatusMove = (ActualVelocity != 0.0);
			StatusStand = (ActualVelocity == 0.0);
			ActualPositionMa1 = ActualPositionMa;
			ActualPositionMa = IOActualPositionAx + offsetAxToMa;
			offsetAxToMa1 = offsetAxToMa;
			MaximumVelocity = MAX_SPEED;

			initDone = 1;


		}

		CB_post_int(servo_control_OperationMode);
		CB_post_bool(servo_control_StatusReady);
		CB_post_bool(servo_control_StatusMove);
		CB_post_bool(servo_control_StatusStand);
		CB_post_float(servo_control_ActualPositionMa);
		CB_post_float(servo_control_ActualVelocity);
		CB_post_float(servo_control_MaximumVelocity);
		CB_post_bool(servo_control_VelEnabled);
		CB_post_bool(servo_control_VelCmd);
		CB_post_bool(servo_control_PosEnabled);
		CB_post_bool(servo_control_PosCmd);
		CB_post_float(servo_control_Position);
		CB_post_float(servo_control_Speed);

		/******************** Post-conditions execution *********************/

		/*no Post-conditions*/
	}

	/*************************** self update ****************************/

	self.Bool += 1;
	self.Int += 1;
	self.Float += 8;

	return 0;
}

